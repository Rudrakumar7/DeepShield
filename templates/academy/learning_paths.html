{% extends 'base.html' %}

{% block content %}
<div class="container fade-in">
    <div class="text-center mb-5">
        <h1 class="font-weight-bold mb-3">üìö Learning Paths</h1>
        <p class="text-secondary">Master cybersecurity with structured, interactive roadmaps.</p>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
        {% for key, path in paths.items() %}
        <li class="nav-item">
            <a class="nav-link px-4 {% if loop.first %}active{% endif %}" id="pills-{{ key }}-tab" data-toggle="pill"
                href="#pills-{{ key }}" role="tab" aria-controls="pills-{{ key }}"
                aria-selected="{{ 'true' if loop.first else 'false' }}">
                {{ path.icon }} {{ path.title }}
            </a>
        </li>
        {% endfor %}
    </ul>

    <!-- Content -->
    <div class="tab-content" id="pills-tabContent">

        {% for key, path in paths.items() %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="pills-{{ key }}" role="tabpanel">
            <div class="glass p-5 border-left-{{ path.color }}">
                <h2 class="text-{{ path.color }} mb-2">{{ path.title }}</h2>
                <p class="lead mb-4">{{ path.description }}</p>

                <!-- Overall Progress -->
                <div class="mb-5">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-secondary">Path Progress</span>
                        <span class="text-primary-accent font-weight-bold" id="progress-text-{{ key }}">0%</span>
                    </div>
                    <div class="progress" style="height: 10px; background: rgba(255,255,255,0.1);">
                        <div class="progress-bar bg-{{ path.color }}" id="progress-bar-{{ key }}" role="progressbar"
                            style="width: 0%"></div>
                    </div>
                </div>

                <h4 class="mb-4">Curriculum Roadmap:</h4>
                <div class="timeline ml-3">

                    {% for module in path.modules %}
                    <div class="timeline-item {{ path.color }} module-card" id="module-{{ key }}-{{ loop.index0 }}">
                        <div class="timeline-content glass p-3 mb-3">
                            <div class="d-flex justify-content-between align-items-center cursor-pointer"
                                data-toggle="collapse" data-target="#collapse-{{ key }}-{{ loop.index0 }}">
                                <div>
                                    <h5 class="text-white mb-1">
                                        {{ loop.index }}. {{ module.title }}
                                        <span class="badge badge-dark ml-2" style="font-size: 0.7em;">{{
                                            module.difficulty }}</span>
                                    </h5>
                                    <p class="mb-0 text-secondary small">{{ module.desc }}</p>
                                </div>
                                <div class="text-right">
                                    <span class="d-block text-muted small">‚è±Ô∏è {{ module.time }}</span>
                                    <i class="fas fa-chevron-down text-secondary mt-1"></i>
                                </div>
                            </div>

                            <!-- Collapsible Details -->
                            <div id="collapse-{{ key }}-{{ loop.index0 }}"
                                class="collapse mt-3 border-top border-secondary pt-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-info">Recommended Resources:</h6>
                                        <ul class="text-secondary small pl-3">
                                            {% for res in module.resources %}
                                            <li>{{ res }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-success">Hands-on Project:</h6>
                                        <p class="text-secondary small fst-italic">"{{ module.project }}"</p>
                                    </div>
                                </div>

                                <button class="btn btn-outline-{{ path.color }} btn-sm btn-block mt-3 mark-complete-btn"
                                    data-path="{{ key }}" data-idx="{{ loop.index0 }}">
                                    Mark as Complete
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                </div>
            </div>
        </div>
        {% endfor %}

    </div>

    <div class="text-center mt-5">
        <a href="{{ url_for('academy') }}" class="btn btn-secondary">‚Üê Back to Academy</a>
    </div>
</div>

<style>
    .nav-pills .nav-link.active {
        background-color: var(--primary);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .nav-pills .nav-link {
        color: var(--text-muted);
        background: rgba(255, 255, 255, 0.05);
        margin: 0 5px;
        border-radius: 50px;
    }

    .border-left-danger {
        border-left: 5px solid var(--danger);
    }

    .border-left-info {
        border-left: 5px solid var(--info);
    }

    .border-left-purple {
        border-left: 5px solid #a020f0;
    }

    /* Custom purple */
    .border-left-primary {
        border-left: 5px solid var(--primary);
    }

    .border-left-success {
        border-left: 5px solid var(--success);
    }

    .module-complete .timeline-content {
        border-left: 4px solid var(--success);
        background: rgba(0, 255, 136, 0.05);
    }

    .module-complete h5 {
        text-decoration: line-through;
        color: var(--text-muted) !important;
    }

    .cursor-pointer {
        cursor: pointer;
    }
</style>

<!-- Bootstrap JS for Tabs/Collapse -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script id="paths-data" type="application/json">
    {{ paths | tojson }}
</script>

<script>
    // --- Local Storage Logic ---
    let userProgress = JSON.parse(localStorage.getItem('academyProgress') || '{}');

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        applyProgress();

        // Event Delegation
        document.body.addEventListener('click', (e) => {
            if (e.target.classList.contains('mark-complete-btn')) {
                const pathId = e.target.dataset.path;
                const idx = parseInt(e.target.dataset.idx);
                toggleModule(pathId, idx);
            }
        });
    });

    function toggleModule(pathId, moduleIdx) {
        if (!userProgress[pathId]) userProgress[pathId] = [];

        const idx = userProgress[pathId].indexOf(moduleIdx);
        if (idx === -1) {
            userProgress[pathId].push(moduleIdx); // Mark complete
        } else {
            userProgress[pathId].splice(idx, 1); // Unmark
        }

        localStorage.setItem('academyProgress', JSON.stringify(userProgress));
        applyProgress();
    }

    function applyProgress() {
        // Parse data from JSON block
        const pathsData = JSON.parse(document.getElementById('paths-data').textContent);

        // Iterate over all paths
        for (const [pathId, path] of Object.entries(pathsData)) {
            const totalModules = path.modules.length;
            const completed = userProgress[pathId] || [];

            // Update Progress Bar
            const percent = Math.round((completed.length / totalModules) * 100);
            const pBar = document.getElementById(`progress-bar-${pathId}`);
            const pText = document.getElementById(`progress-text-${pathId}`);

            if (pBar) pBar.style.width = `${percent}%`;
            if (pText) pText.innerText = `${percent}%`;

            // Update individual module cards
            for (let i = 0; i < totalModules; i++) {
                const card = document.getElementById(`module-${pathId}-${i}`);
                if (!card) continue;

                const btn = card.querySelector('.mark-complete-btn');

                if (completed.includes(i)) {
                    card.classList.add('module-complete');
                    btn.innerText = "Undo Completion";
                    btn.classList.replace(`btn-outline-${path.color}`, 'btn-secondary');
                } else {
                    card.classList.remove('module-complete');
                    btn.innerText = "Mark as Complete";
                    btn.classList.replace('btn-secondary', `btn-outline-${path.color}`);
                }
            }
        }
    }
</script>
{% endblock %}