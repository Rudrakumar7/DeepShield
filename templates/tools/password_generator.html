{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h2 class="mb-4 text-center fw-bold"><i class="fas fa-lock me-2 text-primary"></i> Advanced Password
                Generator</h2>
            <div class="glass p-5 shadow-lg">

                <!-- Type Selector -->
                <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active rounded-pill px-4" id="pills-random-tab" data-bs-toggle="pill"
                            data-bs-target="#pills-random" type="button" role="tab" onclick="setMode('random')"><i
                                class="fas fa-dice me-2"></i>Random</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill px-4" id="pills-passphrase-tab" data-bs-toggle="pill"
                            data-bs-target="#pills-passphrase" type="button" role="tab"
                            onclick="setMode('passphrase')"><i class="fas fa-font me-2"></i>Passphrase</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill px-4" id="pills-personalized-tab" data-bs-toggle="pill"
                            data-bs-target="#pills-personalized" type="button" role="tab"
                            onclick="setMode('personalized')"><i
                                class="fas fa-user-shield me-2"></i>Personalized</button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">

                    <!-- Random Mode -->
                    <div class="tab-pane fade show active" id="pills-random" role="tabpanel">
                        <div class="row g-4 align-items-center">
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-ruler-horizontal me-2"></i>Length:
                                    <span id="lenVal" class="text-primary">16</span></label>
                                <input type="range" class="form-range" min="8" max="64" value="16" id="lengthRange"
                                    oninput="document.getElementById('lenVal').innerText = this.value">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="chkUpper" checked>
                                    <label class="form-check-label">A-Z (Uppercase)</label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="chkDigits" checked>
                                    <label class="form-check-label">0-9 (Digits)</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="chkSymbols" checked>
                                    <label class="form-check-label">!@# (Symbols)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Passphrase Mode -->
                    <div class="tab-pane fade" id="pills-passphrase" role="tabpanel">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-layer-group me-2"></i>Number of
                                    Words: <span id="wordVal" class="text-primary">4</span></label>
                                <input type="range" class="form-range" min="3" max="12" value="4" id="wordsRange"
                                    oninput="document.getElementById('wordVal').innerText = this.value">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="chkCapitalize" checked>
                                    <label class="form-check-label">Capitalize Words</label>
                                </div>
                                <div>
                                    <label class="form-label fw-bold">Separator</label>
                                    <select class="form-select bg-dark text-light border-secondary"
                                        id="separatorSelect">
                                        <option value="-">Hyphen (-)</option>
                                        <option value=".">Dot (.)</option>
                                        <option value=" ">Space ( )</option>
                                        <option value="_">Underscore (_)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Personalized Mode -->
                    <div class="tab-pane fade" id="pills-personalized" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Name / Nickname</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary"
                                    id="nameInput" placeholder="e.g. John">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Important Year</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary"
                                    id="yearInput" placeholder="e.g. 1990">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Safety Keyword</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary"
                                    id="keywordInput" placeholder="e.g. Pizza">
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Action Button -->
                <div class="mt-5 text-center">
                    <button class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm" onclick="generatePassword()">
                        <i class="fas fa-sync-alt me-2"></i>Generate Password
                    </button>
                </div>

                <!-- Output Area -->
                <div class="mt-4">
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control text-center fw-bold bg-dark text-info border-secondary"
                            id="pwdOutput" readonly style="font-family: 'Courier New', monospace; letter-spacing: 1px;">
                        <button class="btn btn-outline-light" type="button" onclick="copyPassword()"
                            data-bs-toggle="tooltip" title="Copy to Clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>

                    <!-- Strength Meter -->
                    <div class="mt-4 p-3 rounded" style="background: rgba(0,0,0,0.2);">
                        <label class="small text-muted mb-1">Password Strength</label>
                        <div class="progress mb-2" style="height: 8px; background-color: rgba(255,255,255,0.1);">
                            <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span id="strengthIcon" class="me-1"></span>
                                <span id="strengthText" class="fw-bold small">-</span>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">Time to Crack: <span id="crackTime"
                                        class="text-light fw-bold">-</span></small>
                            </div>
                        </div>
                        <div id="feedbackArea" class="mt-2 text-warning small fst-italic"></div>
                    </div>
                </div>

                <!-- History Section -->
                <div class="mt-5 border-top border-secondary pt-4">
                    <h5 class="mb-3"><i class="fas fa-history me-2 text-secondary"></i>Recent Passwords</h5>
                    <div id="historyList" class="list-group list-group-flush"
                        style="max-height: 200px; overflow-y: auto;">
                        <!-- JS populates this -->
                        <div class="text-muted small text-center">No history yet.</div>
                    </div>
                    <div class="text-end mt-2">
                        <button class="btn btn-sm btn-outline-danger" onclick="clearHistory()">Clear History</button>
                    </div>
                </div>

            </div>

            <div class="mt-4 text-center">
                <a href="{{ url_for('tools') }}" class="text-decoration-none text-secondary hover-white">
                    <i class="fas fa-arrow-left me-1"></i> Back to Tools
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Toast for Copy -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i> Password copied to clipboard!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
    let currentMode = 'random';

    // Load history on start
    document.addEventListener('DOMContentLoaded', loadHistory);

    function setMode(mode) {
        currentMode = mode;
        // Optionally clear output when switching modes, but keeping it might be nicer
    }

    function resetStrength() {
        document.getElementById('strengthBar').style.width = '0%';
        document.getElementById('strengthBar').className = 'progress-bar';
        document.getElementById('strengthText').innerText = '-';
        document.getElementById('crackTime').innerText = '-';
        document.getElementById('feedbackArea').innerText = '';
        document.getElementById('strengthIcon').innerHTML = '';
    }

    async function generatePassword() {
        const payload = { type: currentMode };

        if (currentMode === 'random') {
            payload.length = document.getElementById('lengthRange').value;
            payload.use_upper = document.getElementById('chkUpper').checked;
            payload.use_digits = document.getElementById('chkDigits').checked;
            payload.use_symbols = document.getElementById('chkSymbols').checked;
        } else if (currentMode === 'passphrase') {
            payload.num_words = document.getElementById('wordsRange').value;
            payload.separator = document.getElementById('separatorSelect').value;
            payload.capitalize = document.getElementById('chkCapitalize').checked;
        } else if (currentMode === 'personalized') {
            payload.name = document.getElementById('nameInput').value;
            payload.year = document.getElementById('yearInput').value;
            payload.keyword = document.getElementById('keywordInput').value;
        }

        try {
            const btn = document.querySelector('button[onclick="generatePassword()"]');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            btn.disabled = true;

            const response = await fetch('/tools/password-generator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) throw new Error('Failed to generate');

            const data = await response.json();
            document.getElementById('pwdOutput').value = data.password;

            updateStrengthUI(data.strength);
            addToHistory(data.password, data.strength.strength);

            btn.innerHTML = originalHtml;
            btn.disabled = false;

        } catch (error) {
            console.error(error);
            alert("Error generating password");
        }
    }

    function updateStrengthUI(strengthData) {
        const bar = document.getElementById('strengthBar');
        const text = document.getElementById('strengthText');
        const crackTime = document.getElementById('crackTime');
        const feedback = document.getElementById('feedbackArea');
        const icon = document.getElementById('strengthIcon');

        // Update Text
        text.innerText = strengthData.strength;
        crackTime.innerText = strengthData.crack_time;
        feedback.innerText = strengthData.feedback.join(' ');

        // Update Bar
        const score = strengthData.score;
        bar.style.width = score + '%';

        // Styling
        bar.className = 'progress-bar'; // reset
        icon.className = 'me-1';

        let colorClass = 'bg-danger';
        let iconClass = 'fa-exclamation-triangle text-danger';

        if (score < 40) {
            colorClass = 'bg-danger';
            iconClass = 'fas fa-exclamation-circle text-danger';
        } else if (score < 70) {
            colorClass = 'bg-warning';
            iconClass = 'fas fa-shield-alt text-warning';
        } else if (score < 90) {
            colorClass = 'bg-info';
            iconClass = 'fas fa-shield-virus text-info';
        } else {
            colorClass = 'bg-success';
            iconClass = 'fas fa-lock text-success';
        }

        bar.classList.add(colorClass);
        icon.innerHTML = `<i class="${iconClass}"></i>`;
    }

    function copyPassword() {
        const pwd = document.getElementById('pwdOutput');
        if (!pwd.value) return;

        pwd.select();
        document.execCommand("copy");

        // Show Toast
        const toastEl = document.getElementById('copyToast');
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    // --- History Functions ---
    const MAX_HISTORY = 5;

    function addToHistory(password, strength) {
        let history = JSON.parse(localStorage.getItem('pwd_history') || '[]');

        // Add new item to top
        history.unshift({
            pwd: password,
            strength: strength,
            time: new Date().toLocaleTimeString()
        });

        // Keep only last N
        if (history.length > MAX_HISTORY) {
            history = history.slice(0, MAX_HISTORY);
        }

        localStorage.setItem('pwd_history', JSON.stringify(history));
        renderHistory(history);
    }

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('pwd_history') || '[]');
        renderHistory(history);
    }

    function renderHistory(history) {
        const list = document.getElementById('historyList');
        if (history.length === 0) {
            list.innerHTML = '<div class="text-muted small text-center p-2">No history yet.</div>';
            return;
        }

        list.innerHTML = history.map(item => `
            <div class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between align-items-center">
                <div class="text-truncate me-3" style="max-width: 250px; font-family: monospace;">${item.pwd}</div>
                <div>
                     <span class="badge bg-secondary me-2">${item.strength}</span>
                     <button class="btn btn-sm btn-link text-light p-0" onclick="copyFromHistory('${item.pwd}')"><i class="fas fa-copy"></i></button>
                </div>
            </div>
        `).join('');
    }

    function clearHistory() {
        localStorage.removeItem('pwd_history');
        renderHistory([]);
    }

    function copyFromHistory(text) {
        navigator.clipboard.writeText(text).then(() => {
            const toastEl = document.getElementById('copyToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        });
    }
</script>

<style>
    /* Custom override for this page */
    .nav-pills .nav-link {
        color: var(--text-secondary);
        background: rgba(255, 255, 255, 0.05);
        margin: 0 5px;
        transition: all 0.3s;
    }

    .nav-pills .nav-link.active {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4);
    }

    .hover-white:hover {
        color: white !important;
    }
</style>
{% endblock %}