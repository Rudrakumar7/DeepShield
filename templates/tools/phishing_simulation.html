{% extends 'base.html' %}

{% block content %}
<div class="container-fluid p-0 fade-in h-100 d-flex flex-column" style="height: calc(100vh - 70px) !important;">

    <!-- Gamified HUD -->
    <div class="d-flex justify-content-between align-items-center px-4 py-3 bg-dark border-bottom border-secondary"
        style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 10;">
        <div class="d-flex align-items-center">
            <div class="mr-4">
                <small class="text-uppercase text-secondary font-weight-bold"
                    style="letter-spacing: 1px;">Health</small>
                <div id="health-bar" style="font-size: 1.5rem;">
                    ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è
                </div>
            </div>
            <div class="mr-4">
                <small class="text-uppercase text-secondary font-weight-bold" style="letter-spacing: 1px;">Level</small>
                <div class="d-flex align-items-center">
                    <span class="badge badge-warning mr-2" id="level-badge" style="font-size: 1rem;">Lvl 1</span>
                    <div class="progress" style="width: 100px; height: 6px; background: rgba(255,255,255,0.1);">
                        <div class="progress-bar bg-warning" id="xp-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <h4 class="mb-0 font-weight-bold text-gradient">Phishing Defense</h4>
            <small class="text-secondary">Wave <span id="current-wave">1</span> (Difficulty: Easy)</small>
        </div>

        <div class="d-flex align-items-center">
            <div class="mr-4 text-right">
                <small class="text-uppercase text-secondary font-weight-bold">Score</small>
                <div class="font-weight-bold text-white" style="font-size: 1.4rem;" id="score-val">0</div>
            </div>
            <div class="mr-3 text-right">
                <small class="text-uppercase text-secondary font-weight-bold">Combo</small>
                <div class="font-weight-bold text-warning" style="font-size: 1.4rem;">x<span id="combo-val">0</span>
                </div>
            </div>
            <button class="btn btn-outline-light btn-sm ml-3" onclick="location.reload()">
                <i class="fas fa-redo"></i>
            </button>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="d-flex flex-grow-1 overflow-hidden position-relative">

        <!-- Power-ups Sidebar -->
        <div class="d-none d-md-flex flex-column bg-dark border-right border-secondary p-3 align-items-center"
            style="width: 80px;">
            <small class="text-center text-secondary mb-3" style="font-size: 0.7rem;">POWER UPS</small>

            <button
                class="btn btn-dark border border-secondary p-2 mb-3 rounded-circle shadow scale-on-hover position-relative"
                onclick="usePowerUp('xray')" data-toggle="tooltip" title="X-Ray (Reveal Links) - Cost: 50pts">
                <span style="font-size: 1.5rem;">üîç</span>
                <span class="badge badge-pill badge-primary position-absolute"
                    style="bottom: -5px; right: -5px;">50</span>
            </button>

            <button
                class="btn btn-dark border border-secondary p-2 mb-3 rounded-circle shadow scale-on-hover position-relative"
                onclick="usePowerUp('hint')" data-toggle="tooltip" title="AI Hint - Cost: 30pts">
                <span style="font-size: 1.5rem;">ü§ñ</span>
                <span class="badge badge-pill badge-primary position-absolute"
                    style="bottom: -5px; right: -5px;">30</span>
            </button>
        </div>

        <!-- Email View (Outlook Style) -->
        <div class="col p-0 d-flex flex-column bg-dark position-relative" id="reading-pane">

            <!-- Loading State -->
            <div id="loading-state" class="h-100 d-flex justify-content-center align-items-center">
                <div class="spinner-border text-primary" role="status"></div>
            </div>

            <!-- Empty State -->
            <div id="game-over-state"
                class="d-none h-100 flex-column justify-content-center align-items-center text-center p-5">
                <div style="font-size: 5rem;" class="mb-3">üíÄ</div>
                <h1 class="text-danger mb-3">System Compromised!</h1>
                <p class="lead text-secondary mb-4">You ran out of health. The attackers got through.</p>
                <h3 class="mb-4">Final Score: <span id="final-score" class="text-white">0</span></h3>
                <button class="btn btn-primary btn-lg px-5 shadow-lg scale-on-hover" onclick="location.reload()">Try
                    Again</button>
            </div>

            <div id="victory-state"
                class="d-none h-100 flex-column justify-content-center align-items-center text-center p-5">
                <div style="font-size: 5rem;" class="mb-3">üèÜ</div>
                <h1 class="text-warning mb-3">Cyber Guardian!</h1>
                <p class="lead text-secondary mb-4">You successfully defended against all waves.</p>
                <h3 class="mb-4">Final Score: <span id="victory-score" class="text-white">0</span></h3>
                <button class="btn btn-primary btn-lg px-5 shadow-lg scale-on-hover" onclick="location.reload()">Play
                    Again</button>
            </div>

            <!-- Email Content -->
            <div id="email-content" class="d-none flex-column h-100 fade-in">
                <!-- Toolbar -->
                <div
                    class="d-flex justify-content-between align-items-center px-4 py-3 border-bottom border-secondary bg-dark-lighter">
                    <div class="font-weight-bold text-white">
                        <i class="fas fa-shield-alt mr-2 text-primary"></i> Incoming Message...
                    </div>
                    <div>
                        <button class="btn btn-danger btn-lg mr-3 shadow-lg scale-on-hover font-weight-bold px-4"
                            onclick="handleDecision('report')">
                            <i class="fas fa-bug mr-2"></i> REPORT PHISHING
                        </button>
                        <button class="btn btn-success btn-lg shadow-lg scale-on-hover font-weight-bold px-4"
                            onclick="handleDecision('archive')">
                            <i class="fas fa-check-circle mr-2"></i> LEGITIMATE
                        </button>
                    </div>
                </div>

                <!-- Email Header -->
                <div class="px-4 py-3 border-bottom border-secondary bg-dark">
                    <div class="d-flex justify-content-between">
                        <h3 class="mb-1 text-white" id="msg-subject">Subject Line</h3>
                        <span class="text-secondary small">Today, 10:30 AM</span>
                    </div>
                    <div class="d-flex align-items-center mt-3">
                        <div class="rounded-circle bg-gradient d-flex align-items-center justify-content-center text-white font-weight-bold mr-3 shadow"
                            style="width: 50px; height: 50px; font-size: 1.2rem;" id="msg-avatar">
                            A
                        </div>
                        <div>
                            <div class="font-weight-bold text-white" style="font-size: 1.1rem;" id="msg-sender-name">
                                Sender Name</div>
                            <div class="text-secondary small font-monospace" id="msg-sender-email">sender@example.com
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Body -->
                <div class="p-5 flex-grow-1 overflow-auto custom-scrollbar"
                    style="background: #1a1a1a; font-size: 1.1rem;">
                    <div id="msg-body" class="email-body-content">
                        <!-- Dynamic Content -->
                    </div>
                </div>

                <!-- AI Hint Box -->
                <div id="ai-hint-box"
                    class="px-4 py-3 bg-dark-lighter border-top border-secondary text-info d-none bounce-in">
                    <i class="fas fa-robot mr-2"></i> <strong>AI Insight:</strong> <span id="ai-hint-text">...</span>
                </div>

                <!-- Fake Status Bar -->
                <div id="link-preview"
                    class="px-3 py-2 bg-black border-top border-secondary text-truncate font-monospace text-warning d-none"
                    style="font-size: 0.9rem;">
                    URL Preview: <span id="link-url">...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quiz Modal -->
<div class="modal fade" id="quizModal" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-dark border border-secondary shadow-lg">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-question-circle text-warning mr-2"></i>Why is
                    this Phishing?</h5>
            </div>
            <div class="modal-body">
                <p class="text-secondary mb-4">Select the primary indicator that makes this email suspicious:</p>
                <div class="list-group">
                    <button type="button"
                        class="list-group-item list-group-item-action bg-dark-light text-light border-secondary mb-2 rounded"
                        onclick="submitQuiz('sender')">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-secret mr-3 text-danger" style="font-size: 1.5rem;"></i>
                            <div>
                                <h6 class="mb-0 font-weight-bold">Suspicious Sender</h6>
                                <small class="text-muted">Mismatched domain, unusual address.</small>
                            </div>
                        </div>
                    </button>
                    <button type="button"
                        class="list-group-item list-group-item-action bg-dark-light text-light border-secondary mb-2 rounded"
                        onclick="submitQuiz('link')">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-link mr-3 text-info" style="font-size: 1.5rem;"></i>
                            <div>
                                <h6 class="mb-0 font-weight-bold">Dangerous Link</h6>
                                <small class="text-muted">Fake URL, URL shortener, http://.</small>
                            </div>
                        </div>
                    </button>
                    <button type="button"
                        class="list-group-item list-group-item-action bg-dark-light text-light border-secondary mb-2 rounded"
                        onclick="submitQuiz('content')">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle mr-3 text-warning" style="font-size: 1.5rem;"></i>
                            <div>
                                <h6 class="mb-0 font-weight-bold">Urgency / Threats</h6>
                                <small class="text-muted">"Act now", "Account suspended", "Gift cards".</small>
                            </div>
                        </div>
                    </button>
                    <button type="button"
                        class="list-group-item list-group-item-action bg-dark-light text-light border-secondary mb-2 rounded"
                        onclick="submitQuiz('file')">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-download mr-3 text-success" style="font-size: 1.5rem;"></i>
                            <div>
                                <h6 class="mb-0 font-weight-bold">Unexpected Attachment</h6>
                                <small class="text-muted">Invoice, Resume, unexpected file.</small>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Level Up Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content bg-dark border border-secondary shadow-lg">
            <div class="modal-body p-0">
                <div class="d-flex">
                    <!-- Status Bar -->
                    <div id="feedback-color-bar" class="bg-success rounded-left" style="width: 15px;"></div>

                    <div class="p-4 flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h1 class="font-weight-bold mb-0 display-4" id="modal-verdict">Correct!</h1>
                                <div class="d-flex align-items-center mt-2">
                                    <span class="badge badge-pill badge-warning mr-2" id="modal-xp">+50 XP</span>
                                    <span class="text-secondary" id="modal-streak">Streak x2</span>
                                </div>
                            </div>
                            <div id="modal-icon" class="display-3 bounce-in">üéâ</div>
                        </div>

                        <div class="card bg-dark-light border-secondary mb-4">
                            <div class="card-body p-3">
                                <div class="d-flex">
                                    <div class="mr-3" style="font-size: 2rem;">üí°</div>
                                    <div>
                                        <h5 class="text-white font-weight-bold mb-1">Did You Know?</h5>
                                        <p id="modal-tip" class="mb-0 text-light"
                                            style="font-size: 1.1rem; opacity: 0.9;">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-secondary font-weight-bold text-uppercase small mb-2">Analysis</h6>
                        <p id="modal-reason" class="text-light mb-3">...</p>

                        <div class="text-right">
                            <button class="btn btn-primary btn-lg px-5 shadow rounded-pill scale-on-hover"
                                onclick="nextScenario()">
                                Next Scenario <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-dark-light {
        background-color: #1e1e1e;
    }

    .bg-dark-lighter {
        background-color: #252525;
    }

    .text-gradient {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .scale-on-hover:hover {
        transform: scale(1.05);
    }

    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .fake-link {
        color: #3498db;
        text-decoration: underline;
        cursor: help;
        font-weight: 500;
        padding: 2px 4px;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .fake-link:hover {
        background: rgba(52, 152, 219, 0.1);
    }

    .fake-link.xray-active {
        background: rgba(231, 76, 60, 0.2);
        border: 1px dashed #e74c3c;
    }

    .bounce-in {
        animation: bounce 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    @keyframes bounce {
        0% {
            transform: scale(0);
            opacity: 0;
        }

        50% {
            transform: scale(1.2);
            opacity: 1;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<script>
    let scenarios = [];
    let currentScenario = null;
    let currentIdx = 0;

    // Game State
    let score = 0;
    let health = 3;
    let xp = 0;
    let combo = 0;
    let level = 1;
    let wave = 1; // 1=Easy, 2=Medium, 3=Hard

    let feedbackModal = null;
    let quizModal = null;

    const LEVEL_THRESHOLDS = [0, 100, 300, 600, 1000];

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Modals
        feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'), { backdrop: 'static', keyboard: false });
        quizModal = new bootstrap.Modal(document.getElementById('quizModal'), { backdrop: 'static', keyboard: false });

        // Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        loadWave(1); // Start with Wave 1

        // Link Hover
        document.getElementById('msg-body').addEventListener('mouseover', (e) => {
            const link = e.target.closest('.fake-link, .fake-btn');
            if (link) {
                const url = link.dataset.url;
                const preview = document.getElementById('link-preview');
                document.getElementById('link-url').innerText = url;
                preview.classList.remove('d-none');
            }
        });

        document.getElementById('msg-body').addEventListener('mouseout', () => {
            const preview = document.getElementById('link-preview');
            if (preview) preview.classList.add('d-none');
        });

        document.getElementById('msg-body').addEventListener('click', (e) => { e.preventDefault(); });
    });

    async function loadWave(waveNum) {
        let diff = 'Easy';
        if (waveNum === 2) diff = 'Medium';
        if (waveNum >= 3) diff = 'Hard';

        wave = waveNum;
        document.querySelector('.text-center small').innerHTML = `Wave <span id="current-wave">${wave}</span> (Difficulty: ${diff})`;

        try {
            // Fetch scenarios for this wave/difficulty
            const res = await fetch(`/api/simulation/scenarios?count=5&difficulty=${diff}`);
            scenarios = await res.json();

            if (scenarios.length > 0) {
                document.getElementById('loading-state').classList.add('d-none');
                currentIdx = 0;
                startRound();
            } else {
                alert("Wave Complete! Starting next wave...");
                loadWave(wave + 1); // Auto progress if no scenarios (fallback)
            }
        } catch (err) {
            console.error(err);
            alert("Connection Failed. Please reload.");
        }
    }

    function startRound() {
        if (health <= 0) return endGame(false);
        if (currentIdx >= scenarios.length) {
            // End of Wave
            if (wave < 3) {
                alert(`Wave ${wave} Complete! Proceeding to Wave ${wave + 1}...`);
                loadWave(wave + 1);
            } else {
                endGame(true); // Victory
            }
            return;
        }

        const s = scenarios[currentIdx];
        currentScenario = s;

        // UI Updates
        document.getElementById('email-content').classList.remove('d-none');
        document.getElementById('ai-hint-box').classList.add('d-none');

        // Content
        const name = s.sender.split('<')[0].trim();
        const email = s.sender.includes('<') ? s.sender.split('<')[1].replace('>', '') : s.sender;

        document.getElementById('msg-subject').innerText = s.subject;
        document.getElementById('msg-sender-name').innerText = name;
        document.getElementById('msg-sender-email').innerText = email;
        document.getElementById('msg-avatar').innerText = name.charAt(0);
        document.getElementById('msg-body').innerHTML = s.body;

        // Reset X-Ray
        document.querySelectorAll('.fake-link').forEach(l => l.classList.remove('xray-active'));
    }

    function handleDecision(decision) {
        if (!currentScenario) return;
        const s = currentScenario;

        // Correct Action Logic: Report if phishing, Archive if safe
        // BUT strict logic: Only Report Phishing triggers quiz? 
        // Or if user says "Archive" on a safe email, that's also correct.

        const isCorrectAction = (decision === 'report' && s.type === 'phishing') ||
            (decision === 'archive' && s.type === 'safe');

        if (isCorrectAction) {
            if (decision === 'report') {
                // Trigger Quiz for Phishing
                quizModal.show();
            } else {
                // Safe email correctly archived - specific win path
                processResult(true, 0); // 0 bonus, standard points
            }
        } else {
            // Wrong Decision
            processResult(false, 0);
        }
    }

    function submitQuiz(answer) {
        // Simple logic: Any "reasonable" answer gets points
        quizModal.hide();
        setTimeout(() => processResult(true, 25), 300); // 25 Bonus XP
    }

    function processResult(isSuccess, bonusXP) {
        const s = currentScenario;

        if (isSuccess) {
            combo++;
            const baseXP = s.xp || 50;
            const streakBonus = Math.min(combo * 10, 50);
            const totalXP = baseXP + streakBonus + bonusXP;

            score += totalXP;
            xp += totalXP;
            checkLevelUp();

            showFeedback(true, totalXP);
        } else {
            combo = 0;
            health--;
            updateHealthUI();
            showFeedback(false, 0);
        }
        updateHUD();
    }

    function usePowerUp(type) {
        if (type === 'xray') {
            if (score < 50) return alert("Not enough score!");
            score -= 50;
            document.querySelectorAll('.fake-link').forEach(l => l.classList.add('xray-active'));
        } else if (type === 'hint') {
            if (score < 30) return alert("Not enough score!");
            score -= 30;
            const hint = currentScenario.type === 'phishing' ? "This email looks suspicious..." : "This sender looks legitimate.";
            document.getElementById('ai-hint-text').innerText = hint;
            document.getElementById('ai-hint-box').classList.remove('d-none');
        }
        updateHUD();
    }

    function showFeedback(isCorrect, gainedXP) {
        const s = currentScenario;

        const color = isCorrect ? 'var(--success)' : 'var(--danger)';
        document.getElementById('feedback-color-bar').style.backgroundColor = color;

        document.getElementById('modal-verdict').innerText = isCorrect ? 'Correct!' : 'Wrong Answer';
        document.getElementById('modal-verdict').style.color = color;
        document.getElementById('modal-icon').innerText = isCorrect ? 'üéâ' : '‚ùå';

        if (isCorrect) {
            document.getElementById('modal-xp').innerText = `+${gainedXP} XP`;
            document.getElementById('modal-xp').className = 'badge badge-pill badge-warning mr-2';
            document.getElementById('modal-streak').innerText = combo > 1 ? `Streak x${combo}` : '';
        } else {
            document.getElementById('modal-xp').innerText = '-1 Health';
            document.getElementById('modal-xp').className = 'badge badge-pill badge-danger mr-2';
            document.getElementById('modal-streak').innerText = '';
        }

        document.getElementById('modal-tip').innerText = s.tip || "Always check the sender address carefully!";
        document.getElementById('modal-reason').innerHTML = s.feedback;

        feedbackModal.show();
    }

    function nextScenario() {
        feedbackModal.hide();
        currentIdx++;
        if (health <= 0) {
            setTimeout(() => endGame(false), 300);
        } else {
            startRound();
        }
    }

    function updateHealthUI() {
        let hearts = '';
        for (let i = 0; i < 3; i++) {
            hearts += i < health ? '‚ù§Ô∏è' : 'üñ§';
        }
        document.getElementById('health-bar').innerText = hearts;
    }

    function updateHUD() {
        document.getElementById('score-val').innerText = score;
        document.getElementById('combo-val').innerText = combo;
        let nextLevelXP = LEVEL_THRESHOLDS[level] || 9999;
        let prevLevelXP = LEVEL_THRESHOLDS[level - 1] || 0;
        let progress = ((xp - prevLevelXP) / (nextLevelXP - prevLevelXP)) * 100;
        document.getElementById('xp-bar').style.width = `${progress}%`;
    }

    function checkLevelUp() {
        if (xp >= LEVEL_THRESHOLDS[level]) {
            level++;
            document.getElementById('level-badge').innerText = `Lvl ${level}`;
        }
    }

    function endGame(victory) {
        document.getElementById('email-content').classList.add('d-none');
        if (victory) {
            document.getElementById('victory-state').classList.remove('d-none');
            document.getElementById('victory-state').classList.add('d-flex');
            document.getElementById('victory-score').innerText = score;
        } else {
            document.getElementById('game-over-state').classList.remove('d-none');
            document.getElementById('game-over-state').classList.add('d-flex');
            document.getElementById('final-score').innerText = score;
        }
    }
</script>
{% endblock %}