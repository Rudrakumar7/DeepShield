{% extends 'base.html' %}

{% block content %}
<div class="container fade-in">
    <!-- Intro Screen -->
    <div id="intro-screen" class="text-center p-4 glass" style="max-width: 800px; margin: 2rem auto;">
        <div style="font-size: 4rem;" class="mb-3 bounce-in">üéì</div>
        <h1 class="mb-2 display-4 font-weight-bold">Phishing Hunter Academy</h1>
        <p class="text-secondary mb-4" style="font-size: 1.1rem;">Before you start, review these 4 signs of a phishing
            attack.</p>

        <div class="row text-left mb-5">
            <div class="col-md-6 mb-3">
                <div class="p-3 border border-secondary rounded h-100" style="background: rgba(255,255,255,0.05);">
                    <h5 class="text-info">1. üìß Check the Sender</h5>
                    <p class="small text-secondary mb-0">Look for typos (e.g., <code>paypa1.com</code>) or random Gmail
                        addresses for official business.</p>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="p-3 border border-secondary rounded h-100" style="background: rgba(255,255,255,0.05);">
                    <h5 class="text-danger">2. ‚è∞ Sense of Urgency</h5>
                    <p class="small text-secondary mb-0">Hackers want you to panic. Watch for "Immediate Action
                        Required" or "Account Suspended".</p>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="p-3 border border-secondary rounded h-100" style="background: rgba(255,255,255,0.05);">
                    <h5 class="text-warning">3. üîó Suspicious Links</h5>
                    <p class="small text-secondary mb-0">Hover over links (don't click!). Does the URL match the company
                        name?</p>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="p-3 border border-secondary rounded h-100" style="background: rgba(255,255,255,0.05);">
                    <h5 class="text-success">4. üëã Generic Greetings</h5>
                    <p class="small text-secondary mb-0">Legitimate companies use your name. Beware of "Dear Customer"
                        or "Dear User".</p>
                </div>
            </div>
        </div>

        <button class="btn btn-primary btn-lg px-5 py-3 shadow-lg scale-on-hover" onclick="startGame()">
            I'm Ready! Start Simulation üöÄ
        </button>
    </div>

    <!-- Game Container (Hidden Initially) -->
    <div id="game-container" style="display: none;">
        <div class="text-center mb-4">
            <h2 class="mb-2">üé£ Phishing Simulation Trainer</h2>
        </div>

        <!-- Gamification Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 gamification-bar glass p-3">
            <div class="d-flex align-items-center" style="min-width: 120px;">
                <span class="mr-3 icon-pulse" style="font-size: 1.8rem;">üî•</span>
                <div>
                    <strong id="streak-display" style="font-size: 1.2rem;">0</strong>
                    <div class="text-secondary" style="font-size: 0.8rem;">Streak</div>
                </div>
            </div>

            <!-- Timer Bar -->
            <div class="flex-grow-1 mx-4 position-relative">
                <div class="d-flex justify-content-between mb-1">
                    <small class="text-secondary">Time Remaining</small>
                    <small id="timer-text" class="text-warning">30s</small>
                </div>
                <div class="progress" style="height: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <div id="timer-bar" class="progress-bar bg-warning"
                        style="width: 100%; border-radius: 10px; transition: width 1s linear;"></div>
                </div>
            </div>

            <div class="d-flex align-items-center text-right" style="min-width: 120px; justify-content: flex-end;">
                <div class="mr-3">
                    <strong id="score-display" style="font-size: 1.2rem;">0</strong>
                    <div class="text-secondary" style="font-size: 0.8rem;">Score</div>
                </div>
                <span style="font-size: 1.8rem;">üèÜ</span>
            </div>
        </div>

        <div class="simulation-container glass p-0 overflow-hidden shadow-lg">
            <!-- Pseudo Browser Header -->
            <div class="browser-header px-4 py-2 d-flex align-items-center"
                style="background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.05);">
                <div class="dots d-flex mr-3">
                    <span class="dot bg-danger rounded-circle" style="width:10px; height:10px;"></span>
                    <span class="dot bg-warning rounded-circle mx-2" style="width:10px; height:10px;"></span>
                    <span class="dot bg-success rounded-circle" style="width:10px; height:10px;"></span>
                </div>
                <div class="url-bar flex-grow-1 text-center text-secondary font-monospace"
                    style="font-size: 0.8rem; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 4px;">
                    <span style="color: var(--success);">üîí</span> Secure Email Client
                </div>
            </div>

            <!-- Scenario Card -->
            <div id="scenario-card" class="p-4 p-md-5">

                <div class="email-mockup mb-5 slide-in-bottom">
                    <div class="email-header p-3 mb-3" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h4 id="email-subject" class="mb-2 text-white">Subject</h4>
                                <p class="mb-1 text-secondary">From: <span id="email-from"
                                        class="text-white font-weight-bold">sender</span></p>
                                <p class="mb-0 text-secondary" style="font-size: 0.85rem;">To: <span
                                        class="text-light">me@deepshield.com</span></p>
                            </div>
                            <!-- Initial Avatar -->
                            <div class="email-avatar d-flex align-items-center justify-content-center font-weight-bold text-white shadow-sm"
                                id="sender-avatar"
                                style="width: 50px; height: 50px; border-radius: 50%; background: var(--primary-gradient);">
                                ?
                            </div>
                        </div>
                    </div>
                    <div class="email-body p-2" id="email-body"
                        style="min-height: 150px; font-size: 1.05rem; line-height: 1.6;">
                        <!-- Body Content -->
                    </div>
                </div>

                <div class="actions text-center">
                    <p class="text-secondary mb-4">Is this email safe or simulated phishing?</p>
                    <button class="btn btn-lg btn-outline-success mx-2 px-5 py-3 action-btn scale-on-hover"
                        onclick="checkAnswer('safe')">
                        <span class="mr-2">‚úÖ</span> Safe
                    </button>
                    <button class="btn btn-lg btn-outline-danger mx-2 px-5 py-3 action-btn scale-on-hover"
                        onclick="checkAnswer('phishing')">
                        <span class="mr-2">üö®</span> Phishing
                    </button>
                </div>
            </div>

            <!-- Result Card -->
            <!-- Result Card -->
            <div id="result-card"
                class="p-4 p-md-5 text-center fade-in h-100 flex-column justify-content-center align-items-center"
                style="display: none; min-height: 400px;">

                <!-- Icon & Title -->
                <div class="mb-4">
                    <div id="feedback-icon" class="mb-3 bounce-in" style="font-size: 5rem; line-height: 1;"></div>
                    <h2 id="feedback-title" class="font-weight-bold display-5"></h2>
                </div>

                <!-- Analysis Box -->
                <div class="glass p-4 mb-4 text-left mx-auto w-100 shadow-sm"
                    style="max-width: 650px; border-left: 6px solid var(--primary); border-radius: 8px; background: rgba(255,255,255,0.03);">
                    <div class="d-flex align-items-center mb-3">
                        <span style="font-size: 1.5rem;" class="mr-2">üîç</span>
                        <h5 class="text-white mb-0 font-weight-bold">Security Analysis</h5>
                    </div>
                    <p id="feedback-desc" class="mb-0 text-light"
                        style="font-size: 1.1rem; line-height: 1.6; opacity: 0.9;"></p>
                </div>

                <!-- Action Button -->
                <div class="mt-2">
                    <button
                        class="btn btn-primary btn-lg px-5 py-3 shadow-lg scale-on-hover font-weight-bold rounded-pill"
                        onclick="nextScenario()">
                        Next Scenario <span class="ml-2">‚Üí</span>
                    </button>
                </div>
            </div>

            <!-- Final Score Card -->
            <div id="final-card" class="p-5 text-center fade-in" style="display: none;">
                <div style="font-size: 6rem;" class="mb-4 bounce-in">üéâ</div>
                <h2 class="mb-3 display-4">Training Complete!</h2>
                <p class="text-secondary mb-5 font-size-lg">You've successfully analyzed all scenarios.</p>

                <div class="row mb-5 justify-content-center">
                    <div class="col-md-4 col-6 text-center border-right border-secondary">
                        <h3 class="display-4 font-weight-bold text-gradient"><span id="final-score-value">0</span></h3>
                        <small class="text-uppercase tracking-widest text-secondary">Correct Answers</small>
                    </div>
                    <div class="col-md-4 col-6 text-center">
                        <h3 class="display-4 font-weight-bold text-warning"><span id="final-streak-value">0</span></h3>
                        <small class="text-uppercase tracking-widest text-secondary">Best Streak</small>
                    </div>
                </div>

                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-outline-primary px-4 mx-2 scale-on-hover" onclick="location.reload()">Replay
                        Training</button>
                    <a href="{{ url_for('tools') }}" class="btn btn-secondary px-4 mx-2 scale-on-hover">Back to
                        Tools</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .simulation-container {
        max-width: 800px;
        margin: 2rem auto;
        height: auto;
    }

    .action-btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-width: 2px;
        border-radius: 50px;
    }

    .scale-on-hover:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .text-gradient {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .icon-pulse {
        animation: pulse-animation 2s infinite;
    }

    @keyframes pulse-animation {
        0% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.2);
            opacity: 0.8;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .bounce-in {
        animation: bounce 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    @keyframes bounce {
        0% {
            transform: scale(0);
            opacity: 0;
        }

        50% {
            transform: scale(1.2);
            opacity: 1;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .slide-in-bottom {
        animation: slide-in 0.5s ease-out;
    }

    @keyframes slide-in {
        from {
            transform: translateY(50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>

<script>
    const scenarios = [
        {
            from: "billing@netflix-support-team.com",
            subject: "Alert: Payment Failed",
            body: `<p>Hi Customer,</p><p>We tried to renew your subscription but the payment failed. Your account will be suspended in 24 hours.</p><p><button class="btn btn-danger btn-sm">Update Payment</button></p><p>Netflix Agent</p>`,
            type: "phishing",
            reason: "<strong>Tip:</strong> Look at the sender domain. It says 'netflix-support-team.com' instead of 'netflix.com'. Also, the urgent 24-hour threat is a common tactic."
        },
        {
            from: "admin@deepshield.com",
            subject: "Scheduled Server Maintenance",
            body: `<p>Team,</p><p>Servers will be down for maintenance this Saturday from 2 AM to 4 AM. No action is required from your end.</p><p>Best,<br>IT Dept</p>`,
            type: "safe",
            reason: "<strong>Correct!</strong> This is a standard informational email from an internal domain. It doesn't ask you to click a link or do anything urgent."
        },
        {
            from: "support@paypa1.com",
            subject: "Urgent: Account Suspended",
            body: `<p>Dear Customer,</p><p>We noticed unusual activity on your account. Please click below to verify your identity within 24 hours or your account will be closed.<br><br><span style="color:#00d2ff; text-decoration:underline;">Verify Now</span></p>`,
            type: "phishing",
            reason: "<strong>Tip:</strong> 'paypa1.com' uses a number '1' instead of the letter 'l'. This is a classic 'typosquatting' attack."
        },
        {
            from: "ceo-private-email@gmail.com",
            subject: "Quick Request",
            body: `<p>Are you at your desk? I need you to buy 5 Google Play gift cards for a prospect. I'm in a meeting and can't call. I'll reimburse you immediately.</p><p>Sent from my iPhone</p>`,
            type: "phishing",
            reason: "<strong>Tip:</strong> This is CEO Fraud. Executives won't email you from a random Gmail account asking for gift cards. Always verify such requests offline."
        },
        {
            from: "notifications@slack.com",
            subject: "New Message from Sarah",
            body: `<p><strong>Sarah (Design Team)</strong> sent you a message:</p><div style="border-left: 3px solid #ccc; padding-left: 10px; color: #888;">'Hey, can you review the new logo drafts when you get a chance?'</div><p><button class="btn btn-primary btn-sm">View Message</button></p>`,
            type: "safe",
            reason: "<strong>Correct!</strong> This mimics a standard Slack notification from their official domain. The request is reasonable and non-urgent."
        },
        {
            from: "hr-payroll@update-files-secure.net",
            subject: "Action Required: Payroll Details",
            body: `<p>Dear Employee,</p><p>We are switching payroll providers. Please login to the new portal to confirm your direct deposit details before Friday to get paid.</p><p>Link: <span style="color: blue; text-decoration: underline;">Portal Login</span></p>`,
            type: "phishing",
            reason: "<strong>Tip:</strong> HR would annouce a major change like this via official channels, not a random 'update-files-secure.net' link. They are trying to steal your bank login."
        }
    ];

    let currentIdx = 0;
    let score = 0;
    let streak = 0;
    let maxStreak = 0;

    // Timer Variables
    let timeLeft = 30;
    let timerInterval;

    function startGame() {
        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        loadScenario();
    }

    function loadScenario() {
        if (currentIdx >= scenarios.length) {
            showFinalScore();
            return;
        }

        const s = scenarios[currentIdx];

        // UI Text
        document.getElementById('email-from').innerText = s.from;
        document.getElementById('email-subject').innerText = s.subject;
        document.getElementById('email-body').innerHTML = s.body;

        // Avatar Logic
        const initial = s.from.charAt(0).toUpperCase();
        document.getElementById('sender-avatar').innerText = initial;

        // Transitions
        document.getElementById('scenario-card').style.display = 'block';
        document.getElementById('result-card').style.display = 'none';

        // Reset classes for animation
        const mockup = document.querySelector('.email-mockup');
        mockup.classList.remove('slide-in-bottom');
        void mockup.offsetWidth; // reflow
        mockup.classList.add('slide-in-bottom');

        startTimer();
    }

    function startTimer() {
        timeLeft = 30;
        updateTimerUI();
        clearInterval(timerInterval);

        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerUI();

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                checkAnswer('timeout');
            }
        }, 1000);
    }

    function updateTimerUI() {
        const percent = (timeLeft / 30) * 100;
        document.getElementById('timer-bar').style.width = `${percent}%`;
        document.getElementById('timer-text').innerText = `${timeLeft}s`;

        // Color Change
        const bar = document.getElementById('timer-bar');
        if (timeLeft > 20) bar.className = "progress-bar bg-success";
        else if (timeLeft > 10) bar.className = "progress-bar bg-warning";
        else bar.className = "progress-bar bg-danger";
    }

    function checkAnswer(userChoice) {
        clearInterval(timerInterval);

        const s = scenarios[currentIdx];
        const isCorrect = userChoice === s.type;

        // Timeout handling
        if (userChoice === 'timeout') {
            // Treat as wrong
            streak = 0;
        } else if (isCorrect) {
            score++;
            streak++;
            if (streak > maxStreak) maxStreak = streak;
        } else {
            streak = 0;
        }

        updateStats();

        // Show result
        document.getElementById('scenario-card').style.display = 'none';
        document.getElementById('result-card').style.display = 'flex';

        const feedbackIcon = document.getElementById('feedback-icon');
        const feedbackTitle = document.getElementById('feedback-title');

        if (userChoice === 'timeout') {
            feedbackIcon.innerText = "‚è∞";
            feedbackTitle.innerText = "Time's Up!";
            feedbackTitle.style.color = "var(--warning)";
        } else if (isCorrect) {
            feedbackIcon.innerText = "üéâ";
            feedbackTitle.innerText = "Correct!";
            feedbackTitle.style.color = "var(--success)";
        } else {
            feedbackIcon.innerText = "‚ùå";
            feedbackTitle.innerText = "Incorrect";
            feedbackTitle.style.color = "var(--danger)";
        }

        document.getElementById('feedback-desc').innerHTML = s.reason;
    }

    function updateStats() {
        document.getElementById('score-display').innerText = score;
        document.getElementById('streak-display').innerText = streak;
    }

    function nextScenario() {
        currentIdx++;
        loadScenario();
    }

    function showFinalScore() {
        clearInterval(timerInterval);

        // Hide game elements
        document.getElementById('scenario-card').style.display = 'none';
        document.getElementById('result-card').style.display = 'none';

        // Hide the gamification bar (it's a class, so use querySelector)
        const gamificationBar = document.querySelector('.gamification-bar');
        if (gamificationBar) gamificationBar.style.display = 'none';

        // Show Final Card
        document.getElementById('final-card').style.display = 'block';

        document.getElementById('final-score-value').innerText = `${score} / ${scenarios.length}`;
        document.getElementById('final-streak-value').innerText = maxStreak;
    }
</script>
{% endblock %}